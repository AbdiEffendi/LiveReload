R = require 'reactive'
_ = require 'underscore'

TypeToRuleClass =
  'compile-file': require('./rule').FileToFileRule


module.exports =
class RuleSet extends R.Model

  schema:
    project:                  { type: Object }
    rules:                    { type: Array }
    availableActions:         { type: Array }

  # 'automatically create default rules': ->
  #   for action in @availableActions
  #     if !@rules.some((rule) -> rule.action is action)
  #       if infos = action.createDefaultRules()
  #         modified = no
  #         for info in infos
  #           rule = @createRule(action, info)
  #           @rules.push rule
  #           modified = yes
  #         if modified
  #           @_changed('rules')

  setMemento: (memento) ->
    @rules =
      for info in memento
        @createRule(@_findAction(info.action), info)

  memento: ->
    (rule.memento() for rule in @rules)

  createRule: (action, info) ->
    # TODO: check that action is one of @availableActions
    ruleClass = @_getRuleClassForAction(action)
    return @universe.create(ruleClass, _.extend({}, { action, @project }, info))

  addRule: (action, info) ->
    @rules.push @createRule(action, info)

  _getRuleClassForAction: (action) ->
    TypeToRuleClass[action.type] or throw new Error "Invalid 'type' of action #{action.constructor.name}: #{JSON.stringify(action.type)}"

  _findAction: (actionId) ->
    _.find(@availableActions, (a) => a.id is actionId) or throw new Error "Unknown action ID #{actionId}"
