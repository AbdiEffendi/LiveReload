debug  = require('debug')('livereload:core:tests')
assert = require 'assert'
{ ok, equal, deepEqual } = require 'assert'
{ inspect } = require 'util'
scopedfs = require 'scopedfs'
fs = require 'fs'
Path = require 'path'

{ EventEmitter } = require 'events'

{ Session, R } = require "../#{process.env.JSLIB or 'lib'}/session"
TestVFS = require 'vfs-test'
{RelPathList} = require 'pathspec'


pluginsDir = process.env.LRBundledPluginsOverride or throw new Error "Set LRBundledPluginsOverride env var to the real plugins path"
unless fs.existsSync Path.join(pluginsDir, 'SASS.lrplugin/manifest.json')
  throw new Error "Provided LRBundledPluginsOverride path does not contain SASS.lrplugin"


clone = (x) -> JSON.parse(JSON.stringify(x))


describe "Session", ->

  it "should monitor the added projects and issue reload requests  TODO: FIXME", (done) ->
    vfs = new TestVFS
    vfs.put '/foo/bar/boz.css', "body: { background: red }\n"

    universe = new R.Universe()
    session = universe.create(Session)
    session.monitoredFiles = { matches: (-> no), excludes: (-> yes) }
    session.addProject vfs, '/foo/bar'

    session.on "command", (message) ->
      assert.equal message.command, 'reload'
      assert.equal message.path, '/foo/bar/boz.css'
      session.close()
      done()

    session.startMonitoring()
    vfs.put '/foo/bar/boz.css', "body: { background: green }\n"


  it "should actually monitor the added projects and issue reload requests", (done) ->
    tempfs = scopedfs.createTempFS('livereload-test-')
    tempfs.applySync 'boz.css': "body: { background: red }\n"

    universe = new R.Universe()
    session = universe.create(Session)
    session.addProject require('vfs-local'), tempfs.path

    await setTimeout(defer(), 100)

    session.on "browser-command", (message) ->
      assert.equal message.command, 'reload'
      assert.equal message.path, 'boz.css'
      session.close()
      done()

    tempfs.applySync 'boz.css': "body: { background: green }\n"


  it "should obey the list of monitored files", (done) ->
    tempfs = scopedfs.createTempFS('livereload-test-')
    tempfs.applySync 'boz.css': "body: { background: red }\n"

    universe = new R.Universe()
    session = universe.create(Session)
    session.monitoredFiles = RelPathList.parse(["*.js"])
    session.addProject require('vfs-local'), tempfs.path

    await setTimeout(defer(), 100)

    _lastCommand = null
    session.on "browser-command", (message) ->
      _lastCommand = message

    tempfs.applySync 'boz.css': "body: { background: green }\n"

    await setTimeout(defer(), 500)
    deepEqual _lastCommand, null

    session.close()
    done()


  it "should implement addInterface", ->
    face = new EventEmitter()
    universe = new R.Universe()
    session = universe.create(Session)
    session.addInterface(face)
    assert.equal face.listeners('command').length, 1


  it "should be able to load a memento", ->
    universe = new R.Universe()
    session = universe.create(Session)
    vfs = new TestVFS
    session.setProjectsMemento vfs, {
      '/foo/bar': { compilationEnabled: 1 }
      '/foo/boz': { compilationEnabled: 0 }
    }

    assert.equal session.projects.length, 2

    bar = session.findProjectByPath('/foo/bar')
    assert.ok bar?
    assert.equal bar.compilationEnabled, true

    boz = session.findProjectByPath('/foo/boz')
    assert.ok boz?
    assert.equal boz.compilationEnabled, false


  it "should handle 'save' command", (done) ->
    vfs = new TestVFS()
    vfs.put '/foo/bar/app/static/test.css', "h1 { color: red }\n"

    universe = new R.Universe()
    session = universe.create(Session)
    session.setProjectsMemento vfs, {
      '/foo/bar': { urls: ['example.com'] }
    }
    session.addProject vfs, '/foo/bar'

    session.execute { command: 'save', url: 'http://example.com/static/test.css', content: "h1 { color: green }\n" }, null, (err) ->
      assert.ifError err
      assert.equal vfs.get('/foo/bar/app/static/test.css'), "h1 { color: green }\n"
      done()


  it "should involve postproc plugin when loading a memento", ->
    universe = new R.Universe()
    session = universe.create(Session)
    vfs = new TestVFS
    session.setProjectsMemento vfs, {
      '/foo/bar': { postproc: 'foo' }
    }

    bar = session.findProjectByPath('/foo/bar')
    assert.ok bar?
    assert.equal bar.postprocCommand, 'foo'
    assert.equal bar.postprocLastRunTime, 0


  it "should handle changes in a static asset file", (done) ->
    universe = new R.Universe()
    session = universe.create(Session)
    vfs = new TestVFS

    requests = []
    session.queue.on 'running', (job) -> requests.push(job.request)

    session.setProjectsMemento vfs, {
      '/foo/bar': { compilationEnabled: yes }
    }

    bar = session.findProjectByPath('/foo/bar')
    assert.ok bar?

    runs = session.handleChange vfs, '/foo/bar', ['boz.js']
    assert.equal runs.length, 1
    assert.equal runs[0].project, bar

    await session.after defer()

    debug "requests = %j", requests
    assert.deepEqual requests, [
      { action: 'rescan-plugins' }
      { action: 'analyzer-rebuild', project: runs[0].project.id }
      { action: 'compile', project: runs[0].project.id, paths: ['boz.js'], changes: [{ paths: ['boz.js'], reloadRequests: [{ path: 'boz.js', originalPath: null }] }] }
      { action: 'postproc', project: runs[0].project.id }
      { action: 'refresh', project: runs[0].project.id, reloadRequests: [{ path: 'boz.js', originalPath: null }] }
    ]
    done()


  it "should handle quick file creation+deletion", (done) ->
    universe = new R.Universe()
    session = universe.create(Session)
    vfs = new TestVFS
    tempfs = scopedfs.createTempFS('livereload-test-')

    memento = {}
    memento[tempfs.path] = { compilationEnabled: yes }
    session.setProjectsMemento vfs, memento

    bar = session.findProjectByPath(tempfs.path)
    assert.ok bar?

    await session.after defer()

    tempfs.applySync 'boz.less': "h1 span { color: #777; }\n"
    session.handleChange vfs, tempfs.path, ['boz.less']

    tempfs.applySync 'boz.less': null
    session.handleChange vfs, tempfs.path, ['boz.less']

    await session.after defer()

    done()


  it "should handle folder change events delivered after removing a project (UV3122)", (done) ->
    universe = new R.Universe()
    session = universe.create(Session)
    vfs = new TestVFS
    tempfs = scopedfs.createTempFS('livereload-test-')

    memento = {}
    memento[tempfs.path] = { compilationEnabled: yes }
    session.setProjectsMemento vfs, memento

    bar = session.findProjectByPath(tempfs.path)
    assert.ok bar?

    await session.after defer()

    debug "!!! monitorWacher = bar.watcher.watcher"
    # monitorWacher = bar.watcher.watcher

    bar.destroy()
    debug "!!! destroy"

    tempfs.applySync 'boz/boz111.less': "h1 { color: red; }\n"
    # monitorWacher.emit 'change', tempfs.path, 'boz111.less', no

    await session.after defer()

    await setTimeout defer(), 500

    done()


  # I know, I know, these tests are ridiculously long with copious amounts of code duplication.
  # You can rejoice in the fact that I hate them too.
  # Maybe one sunny day...

  it "should handle changes in a compilable file when compilation is enabled", (done) ->
    universe = new R.Universe()
    session = universe.create(Session)
    session.addPluginFolder pluginsDir
    vfs = new TestVFS
    tempfs = scopedfs.createTempFS('livereload-test-')

    tempfs.applySync 'boz.coffee': 'alert 42'

    memento = {}
    memento[tempfs.path] = { compilationEnabled: yes }
    session.setProjectsMemento vfs, memento

    bar = session.findProjectByPath(tempfs.path)
    assert.ok bar?

    await
      session.after defer()
      bar.once 'complete', defer()

    requests = []
    session.queue.on 'running', (job) -> requests.push(clone(job.request))

    tempfs.applySync 'boz.coffee': 'alert 43'
    runs = session.handleChange vfs, tempfs.path, ['boz.coffee']
    assert.equal runs.length, 1
    assert.equal runs[0].project, bar

    await session.after defer()

    # debug "requests = %j", requests
    assert.deepEqual requests, [
      { action: 'analyzer-update', project: runs[0].project.id, relpaths: ['boz.coffee'] }
      { action: 'compile', project: runs[0].project.id, paths: ['boz.coffee'], changes: [{ paths: ['boz.coffee'], reloadRequests: [{ path: 'boz.coffee', originalPath: null }] }] }
      { action: 'postproc', project: runs[0].project.id }
      { action: 'refresh', project: runs[0].project.id, reloadRequests: [] }
    ]
    done()


  it "should handle changes in a compilable file when compilation is disabled", (done) ->
    universe = new R.Universe()
    session = universe.create(Session)
    session.addPluginFolder pluginsDir
    vfs = new TestVFS
    tempfs = scopedfs.createTempFS('livereload-test-')

    tempfs.applySync 'boz.coffee': 'alert 42'

    memento = {}
    memento[tempfs.path] = { compilationEnabled: no }
    session.setProjectsMemento vfs, memento

    bar = session.findProjectByPath(tempfs.path)
    assert.ok bar?

    await
      session.after defer()
      bar.once 'complete', defer()

    requests = []
    session.queue.on 'running', (job) -> requests.push(clone(job.request))

    tempfs.applySync 'boz.coffee': 'alert 43'
    runs = session.handleChange vfs, tempfs.path, ['boz.coffee']
    assert.equal runs.length, 1
    assert.equal runs[0].project, bar

    await session.after defer()

    # debug "requests = %j", requests
    assert.deepEqual requests, [
      { action: 'analyzer-update', project: runs[0].project.id, relpaths: ['boz.coffee'] }
      { action: 'compile', project: runs[0].project.id, paths: ['boz.coffee'], changes: [{ paths: ['boz.coffee'], reloadRequests: [{ path: 'boz.coffee', originalPath: null }] }] }
      { action: 'postproc', project: runs[0].project.id }
      { action: 'refresh', project: runs[0].project.id, reloadRequests: [{ path: 'boz.js', originalPath: 'boz.coffee' }] }
    ]
    done()

  # describe '#addRuby()', ->

  #   it "should add the given object to .rubies", ->
  #     universe = new R.Universe()
  #     session = universe.create(Session)
  #     session.addRuby { version: '1.9.3', path: '~/.rvm/rubies/ruby-1.9.3' }
  #     equal session.rubies.length, 1
  #     equal session.rubies[0].version, '1.9.3'
  #     equal session.rubies[0].path,    '~/.rvm/rubies/ruby-1.9.3'
