var assert = require('assert');
var createPingPong = require('../example/pingpong').endpoint;
var createMuxer = require('../lib/muxer').endpoint;

describe("Muxer service", function() {
  it("compiles a list of provided services", function(done) {
    var events = [];
    var carrier = { send: function(message) { events.push(message); }};

    var muxer = createMuxer(carrier);
    createPingPong(muxer);

    setTimeout(function() {
      assert.deepEqual(events, [{ command: 'hello', services: ['pingpong'] }]);
      done();
    }, 5);
  });

  it("routes incoming commands to services, sends the results back", function(done) {
    var events = [];
    var carrier = { send: function(message) { events.push(message); }};

    var muxer = createMuxer(carrier);
    createPingPong(muxer);

    muxer.onmessage({ service: 'pingpong', command: 'ping', reply: { service: 'test', callback: 1 }});

    setTimeout(function() {
      assert.deepEqual(events, [{ command: 'hello', services: ['pingpong'] }, { service: 'test', callback: 1, result: 42 }]);
      done();
    }, 5);
  });
});
