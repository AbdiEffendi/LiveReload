var deepEqual = require('assert').deepEqual;
var MemoryStream = require('memorystream');
var NodeStreamCarrier = require('../lib/carriers/node-stream');

describe("NodeStreamCarrier", function() {

  beforeEach(function() {
    this.input  = new MemoryStream();
    this.output = new MemoryStream(null, { readable: false });
    this.carrier = new NodeStreamCarrier(this.input, this.output);

    this.messages = [];
    var _this = this;
    this.carrier.on('message', function(message) {
      _this.messages.push(message);
    });
  });

  it("emits 'message' after receiving an incoming message", function() {
    this.input.write(JSON.stringify(['foo', 42]) + "\n");
    deepEqual(this.messages, [['foo', 42]]);
  });

  it("emits 'message' twice after receiving two messages in one payload", function() {
    this.input.write(JSON.stringify(['foo', 42]) + "\n" + JSON.stringify(['bar', 24]) + "\n");
    deepEqual(this.messages, [['foo', 42], ['bar', 24]]);
  });

});
