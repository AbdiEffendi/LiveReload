# Reloader Service

Handles web browser reload requests.


## Preamble

    debug = require('debug')('livereload:reloader')
    {RelPathList} = require 'pathspec'


## Exports

    exports.create = ->
      new ReloaderService()


## Implementation

    class ReloaderService
      constructor: ->
        @name = 'reloader'

        @_reloadTimer = null
        @_resetPendingRequest()

        @_liveReloadMasks = RelPathList.parse(["*.css", "*.png", "*.jpg", "*.gif"])

      reload: (request, callback) ->
        @_appendRequestToPending(request)
        @_scheduleReloading()
        callback()

      _resetPendingRequest: ->
        @_pendingRequest = { changes: [], forceFullReload: no, fullReloadDelay: 0 }

      _appendRequestToPending: ({ changes, forceFullReload, fullReloadDelay }) ->
        Array_pushAll @_pendingRequest.changes, changes  if changes?
        @_pendingRequest.forceFullReload or= forceFullReload  if forceFullReload?
        @_pendingRequest.fullReloadDelay = Math.max(@_pendingRequest.fullReloadDelay, fullReloadDelay)  if fullReloadDelay?

      _scheduleReloading: ->
        delay = (if @_isFullReloadPending() then @_pendingRequest.fullReloadDelay else 0)

        clearTimeout(@_reloadTimer) if @_reloadTimer
        @_reloadTimer = setTimeout(@_performReload.bind(@), delay)

      _performReload: ->
        @_reloadTimer = null

        isFull = @_isFullReloadPending()

        messages =
          for change in @_pendingRequest.changes
            {
              command: 'reload'
              path:         change.path
              originalPath: change.originalPath or ''
              liveCSS:      !@_pendingRequest.forceFullReload

              # TODO
              # enableOverride and @urlOverrideCoordinator.shouldOverrideFile(path) and @urlOverrideCoordinator.createOverrideURL(path)
              overrideURL:  undefined
            }

        debug "Send browser reload messages: %j", messages
        @send 'browser.reload', messages

        @_resetPendingRequest()


Live refresh is only available for a pre-defined list of extensions:

      _isFullReloadPending: ->
        @_pendingRequest.forceFullReload or !@_canRefreshChangesLive(@_pendingRequest.changes)

      _canRefreshChangesLive: (changes) ->
        changes.every((change) => @_canRefreshPathLive(change.path))

      _canRefreshPathLive: (path) ->
        @_liveReloadMasks.matches(path)


## Helpers

    Array_pushAll = (array, source) ->
      array.push.apply(array, source)
