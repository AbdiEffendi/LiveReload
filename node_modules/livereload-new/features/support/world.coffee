main = require "../../#{process.env.JSLIB or 'lib'}/main"
rpc  = require "../../#{process.env.JSLIB or 'lib'}/rpc"

class World
  constructor: (callback) ->
    @rpc = rpc.createConnection(rpc.createMockTransport())
    main.exposeServices(@rpc)

    { @i, @o, @reply } = @rpc.transport

    callback()

  shutdown: (callback) ->
    @i 'browser.shutdown', {}, '$shutdown-complete'
    @o '$shutdown-complete', null, =>
      @rpc.transport.emit 'end'
      callback()

module.exports = ->
  @World = World

  @After (callback) ->
    @shutdown(callback)
