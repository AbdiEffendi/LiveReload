debug = require('debug')('livereload:main')
soa = require 'livereload-soa'

exports.run = (argv) ->
  # There are no command-line options at the moment.
  carrier = new soa.NodeStreamCarrier(process.stdin, process.stdout)
  require('./endpoint')(carrier)

  carrier.on 'end', shutdown


# This isn't really required because the service will be killed when the main app quits. (Is that true on a Mac? Certainly true on Windows, we're using a Job object to handle that.)
shutdown = ->

  # Output a string to mark this point in the logs. We sometimes receive logs that just end abruptly at an arbitrary line, so it's important to signal whether backend shutdown has actually happened.
  process.stderr.write "Backend shutdown.\n"

  # Nobody's interested in this exit code anyway, so code zero is as good as any.
  process.exit 0

  # The use of `process.exit` here is quite questionable; for example, we might be in the middle of writing a file at the moment. On the other hand, the background processing time is unbounded; we may even be stuck in an endless async loop, and maybe that's why the user is shutting us down in the first place.

  # The best approach here would be to simulate ‘sudden termination’ semantics of OS X, setting a flag during dangerous operations like async file writes, but allowing an immediate shutdown at any other time.
