domain = require 'domain'
{ EventEmitter } = require 'events'


merge = (dst, src) ->
  for own key, value of src
    if (key.match /^#/) and dst.hasOwnProperty(key) and value? and (oldValue = dst[key])? and (typeof value is 'object') and (typeof oldValue is 'object')
      merge oldValue, value
    else
      dst[key] = value
  dst


module.exports =
class UIConnector extends EventEmitter

  constructor: (@root, options={}) ->
    console.log "UIConnector.constructor: #{@root}"
    @_delay = options.delay ? 20

    @_domain = domain.create()
    @_domain.add(this)

    @root.on 'update', @_mergeUpdate.bind(this)
    @_nextUpdatePayload = {}
    @_nextUpdateScheduled = no

  _mergeUpdate: (payload, callback) ->
    console.log "UIConnector._mergeUpdate: #{JSON.stringify(payload)}"
    if callback
      @emit 'update', payload, callback
    else
      merge @_nextUpdatePayload, payload
      @_scheduleUpdate()
      # @emit 'update', payload

  _scheduleUpdate: ->
    return if @_nextUpdateScheduled
    @_nextUpdateScheduled = yes

    func = @_sendUpdate.bind(this)
    if @_delay is 0
      timer = process.nextTick func
    else
      timer = setTimeout func, @_delay
    @_domain.add(timer)

  _sendUpdate: ->
    payload = @_nextUpdatePayload
    @_nextUpdatePayload = {}
    @_nextUpdateScheduled = no

    @emit 'update', payload
